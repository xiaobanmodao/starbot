<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StarBot</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #1a1a2e; color: #eee; height: 100vh; display: flex; flex-direction: column; }
#header { padding: 12px 20px; background: #16213e; border-bottom: 1px solid #0f3460; display: flex; align-items: center; justify-content: space-between; }
#header h1 { font-size: 18px; color: #e94560; }
#header button { background: #0f3460; color: #eee; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; }
#header button:hover { background: #e94560; }
#messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
.msg { max-width: 85%; padding: 10px 14px; border-radius: 8px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
.msg.user { align-self: flex-end; background: #0f3460; }
.msg.assistant { align-self: flex-start; background: #16213e; }
.msg.tool-call { align-self: flex-start; background: #1a1a2e; border: 1px solid #e94560; font-size: 13px; }
.msg.tool-result { align-self: flex-start; background: #1a1a2e; border: 1px solid #2d6a4f; font-size: 13px; max-height: 300px; overflow-y: auto; }
.msg.confirm { align-self: flex-start; background: #3d1c02; border: 1px solid #e94560; }
.msg.confirm button { margin: 6px 6px 0 0; padding: 4px 12px; border: none; border-radius: 4px; cursor: pointer; }
.msg.confirm .yes { background: #2d6a4f; color: #fff; }
.msg.confirm .no { background: #e94560; color: #fff; }
.label { font-weight: bold; font-size: 12px; color: #888; margin-bottom: 4px; }
#input-area { padding: 12px 16px; background: #16213e; border-top: 1px solid #0f3460; display: flex; gap: 8px; }
#input-area textarea { flex: 1; background: #1a1a2e; color: #eee; border: 1px solid #0f3460; border-radius: 6px; padding: 10px; font-size: 14px; resize: none; min-height: 44px; max-height: 120px; font-family: inherit; }
#input-area button { background: #e94560; color: #fff; border: none; padding: 0 20px; border-radius: 6px; cursor: pointer; font-size: 14px; }
#input-area button:disabled { opacity: 0.5; cursor: not-allowed; }
</style>
</head>
<body>
<div id="header">
  <h1>‚≠ê StarBot</h1>
  <button onclick="clearChat()">Ê∏ÖÁ©∫ÂØπËØù</button>
</div>
<div id="messages"></div>
<div id="input-area">
  <textarea id="input" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." rows="1" onkeydown="handleKey(event)"></textarea>
  <button id="send-btn" onclick="send()">ÂèëÈÄÅ</button>
</div>
<script>
const msgs = document.getElementById('messages');
const input = document.getElementById('input');
const sendBtn = document.getElementById('send-btn');
let ws = null, busy = false, currentAssistant = null;

function connect() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${proto}://${location.host}/ws`);
  ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    if (data.type === 'text') {
      if (!currentAssistant) {
        currentAssistant = addMsg('assistant', '');
      }
      currentAssistant.textContent += data.content;
      scrollBottom();
    } else if (data.type === 'tool_call') {
      currentAssistant = null;
      addMsg('tool-call', `üîß ${data.name}\n${data.arguments}`, `Â∑•ÂÖ∑Ë∞ÉÁî®`);
    } else if (data.type === 'confirm') {
      currentAssistant = null;
      const el = addMsg('confirm', `‚ö†Ô∏è Á°ÆËÆ§ÊâßË°å ${data.name}Ôºü`);
      const yesBtn = document.createElement('button');
      yesBtn.className = 'yes'; yesBtn.textContent = 'ÂÖÅËÆ∏';
      yesBtn.onclick = () => { ws.send(JSON.stringify({type:'confirm',approved:true})); el.querySelectorAll('button').forEach(b=>b.disabled=true); };
      const noBtn = document.createElement('button');
      noBtn.className = 'no'; noBtn.textContent = 'ÊãíÁªù';
      noBtn.onclick = () => { ws.send(JSON.stringify({type:'confirm',approved:false})); el.querySelectorAll('button').forEach(b=>b.disabled=true); };
      el.appendChild(yesBtn); el.appendChild(noBtn);
    } else if (data.type === 'tool_result') {
      const text = data.result.length > 2000 ? data.result.slice(0,2000)+'...' : data.result;
      addMsg('tool-result', text, `ÁªìÊûú: ${data.name}`);
    } else if (data.type === 'done') {
      currentAssistant = null;
      busy = false;
      sendBtn.disabled = false;
      input.focus();
    } else if (data.type === 'cleared') {
      msgs.innerHTML = '';
    }
  };
  ws.onclose = () => setTimeout(connect, 2000);
}

function addMsg(cls, text, label) {
  const el = document.createElement('div');
  el.className = 'msg ' + cls;
  if (label) {
    const lb = document.createElement('div');
    lb.className = 'label'; lb.textContent = label;
    el.appendChild(lb);
  }
  el.appendChild(document.createTextNode(text));
  msgs.appendChild(el);
  scrollBottom();
  return el;
}

function scrollBottom() { msgs.scrollTop = msgs.scrollHeight; }

function send() {
  const text = input.value.trim();
  if (!text || busy || !ws) return;
  addMsg('user', text);
  ws.send(JSON.stringify({type:'message', content: text}));
  input.value = '';
  busy = true;
  sendBtn.disabled = true;
}

function clearChat() {
  if (ws) ws.send(JSON.stringify({type:'clear'}));
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
}

connect();
</script>
</body>
</html>
